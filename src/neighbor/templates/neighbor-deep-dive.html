<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neighbor Screens</title>
    
    <!-- Self-hosted fonts for Playwright -->
    <style>
        @font-face { font-family:"DM Sans"; src:url("fonts/DMSans-Regular.woff2") format("woff2"); font-weight:400; font-style:normal; font-display:swap; }
        @font-face { font-family:"DM Sans"; src:url("fonts/DMSans-Medium.woff2") format("woff2"); font-weight:500; font-style:normal; font-display:swap; }
        @font-face { font-family:"DM Sans"; src:url("fonts/DMSans-Bold.woff2") format("woff2"); font-weight:700; font-style:normal; font-display:swap; }
        @font-face { font-family:"Inter"; src:url("fonts/Inter-Variable.woff2") format("woff2"); font-weight:300 700; font-style:normal; font-display:swap; }
    </style>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 16:9 slide system */
        @page { size: 10in 5.625in; margin: 0; }
        html, body { width: 10in; height: 5.625in; margin: 0; }

        body.slides {
            background: #F1F5F9;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            counter-reset: link-counter;
        }
        
        /* Brand (adjust to Helpen brand kit) */
        :root{
            --hp-navy:#0B1D3A;
            --hp-accent:#007BFF;
            --hp-bg:#F1F5F9;
            --font-main: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            --text-dark: #0B1D3A;
        }
        
        /* One "slide" per page */
        .slide {
            width: 10in; height: 5.625in; 
            display: grid; 
            grid-template-rows: 0.9in auto 0.5in;  /* header / content / footer */
            padding: 0.4in 0.25in;
            box-sizing: border-box;
            page-break-after: always;
            background: #fff;
        }
        .slide:last-of-type { page-break-after: auto; }
        
        /* Safe header/footer bars */
        .slide .header {
            display:flex; align-items:center; justify-content:space-between;
        }
        .slide .footer {
            display:flex; align-items:center; justify-content:space-between;
            font-size: 10pt; color:#475569;
        }
        
        /* Fix headings (remove over-tracking; use tight caps) */
        h1, h2 {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.02em;        /* was too large; keep subtle */
            font-family: 'DM Sans', Inter, sans-serif;
            color: var(--hp-navy);
        }
        .cover h1 { font-size: 40pt; line-height: 1.05; }
        .cover h2 { font-size: 16pt; font-weight: 500; letter-spacing: 0.01em; }
        .summary h2, .table h2 { font-size: 18pt; }
        .table h2 { font-size: 18pt; color: var(--hp-navy); font-family: 'DM Sans', Inter, sans-serif; }
        
        /* Tables - exact copy from diligence */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px; /* Reduced from 30px by 50% */
            margin-bottom: 30px; /* Ensure padding from bottom */
            page-break-inside: auto;
            table-layout: fixed; /* Enforce specified column widths */
        }
        
        th {
            background-color: #F7F9FB;
            font-weight: 600;
            text-align: left;
            padding: 0.08in 0.1in;
            font-size: 7pt;
            border-bottom: 2px solid #E2E8F0;
            font-family: var(--font-main);
            color: var(--text-dark);
        }
        
        td {
            padding: 0.06in 0.1in;
            border-bottom: 1px solid #F1F5F9;
            vertical-align: top;
            line-height: 1.4;
            font-size: 7pt;
        }
        
        /* Page break rules to prevent row splitting */
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        
        thead {
            display: table-header-group; /* Repeat header on new pages */
        }
        
        tfoot {
            display: table-footer-group;
        }
        
        .table-wrapper {
            overflow: visible;
            page-break-inside: auto;
        }
        
        /* Ensure proper page breaking for multi-page tables */
        .content {
            padding-bottom: 30px; /* Ensure content doesn't touch bottom */
        }
        
        /* Citation circles */
        .citation-circle {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #E5E7EB;
            border-radius: 50%;
            font-size: 6px;
            color: #6B7280;
            text-align: center;
            line-height: 10px;
            vertical-align: super;
            text-decoration: none;
            margin-left: 2px;
            cursor: pointer;
        }

        .citation-circle:hover {
            background-color: #D1D5DB;
        }

        /* Section grouping to prevent H3+summary+table separation */
        .section-group {
            page-break-inside: auto;
            break-inside: auto;
        }

        /* Prevent Organizations H3 and summary from separating */
        .organizations-header-group {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .section-summary {
            background: #F7F9FB;
            padding: 0.1in 0.15in;
            border-radius: 4px;
            margin: 10px 0 15px 0;
            border-left: 2px solid #007BFF;
            font-family: 'Inter', sans-serif;
            font-size: 8pt;
            color: #0B1D3A;
            line-height: 1.4;
        }

        /* Print color adjustment and page break rules */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background: #fff !important; /* Ensure white background on all pages */
            }
            
            /* Ensure all pages have white background */
            @page {
                background: #fff;
                margin: 0;
            }
            
            /* Let tables break cleanly */
            table { page-break-before: auto; page-break-after: auto; page-break-inside: auto; }
            tr    { page-break-inside: avoid; page-break-after: auto; }
            
            /* Repeat headers; don't try to margin them */
            thead { display: table-header-group; margin-top: 0 !important; }
            
            /* ✅ Add 25px only on follow-on pages of this block */
            .content {
                padding-top: 25px;                 /* the spacer you want */
                margin-top: -5px;                  /* small adjustment to not overlap header */
                -webkit-box-decoration-break: clone;
                box-decoration-break: clone;       /* clone padding on each page fragment */
                overflow: visible;                 /* ensure the block can fragment in print */
                background: #fff !important;       /* Ensure content has white background */
            }
            
            .slide {
                padding-bottom: 30px !important;
                background: #fff !important;       /* Force white background on slides */
            }
        }

        /* Automatic link numbering for citations */
        a {
            font-size: 0;
            counter-increment: link-counter;
        }

        a::after {
            content: counter(link-counter);
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #F7F9FB;
            color: #0B1D3A;
            text-align: center;
            line-height: 10px;
            font-size: 6px;
            font-weight: 600;
            text-decoration: none;
            margin-left: 1px;
            vertical-align: super;
        }

        /* Influence badges */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 6.5pt;
            font-weight: 500;
        }
        .badge-high {
            background: rgba(59, 130, 246, 0.15);
            color: #2563EB;
        }
        .badge-medium {
            background: rgba(249, 115, 22, 0.15);
            color: #EA580C;
        }
        .badge-low {
            color: #64748B;
        }

        /* Stance text colors */
        .stance-support {
            color: #16A34A;
        }
        .stance-opposed {
            color: #DC2626;
        }
        .stance-unknown {
            color: #64748B;
        }
    </style>
</head>
<body class="slides">
    <section class="slide table">
        
        <!-- Header area -->
        <div class="header" style="padding-bottom: 10px;">
            <div class="header-left">
                <img src="Helpen_Logo_Dark_Navy.svg" alt="Helpen Logo" style="height:0.35in; width:auto; display: block;" />
                <div style="font-family: 'Inter', sans-serif; font-weight: 500; font-size: 10pt; color: #007BFF; text-transform: uppercase; letter-spacing: 0.15em; display: flex; align-items: center; gap: 0.1in; margin-top: 30px;">
                    <div style="width: 0.25in; height: 1px; background: #007BFF; opacity: 0.5;"></div>
                    NEIGHBOR SCREENS
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 9pt; color: #0B1D3A; font-weight: 600; margin-bottom: 6px;">Analyzed:</div>
                <div style="font-size: 8pt; color: #64748B; line-height: 1.3;">
                    {% set resident_count = neighbors|selectattr('entity_category', 'equalto', 'Resident')|list|length %}
                    {% set org_count = neighbors|selectattr('entity_category', 'equalto', 'Organization')|list|length %}
                    <div>{{ resident_count }} Residents</div>
                    <div>{{ org_count }} Entities</div>
                    <div style="margin-top: 8px; padding: 6px 0; border-top: 1px solid #E2E8F0; font-size: 7pt; color: #94A3B8; line-height: 1.4; background: rgba(255,255,255,0.9); position: relative; z-index: 10;">
                        <div style="margin-bottom: 2px;">Adj. = Adjacent Parcel</div>
                        <div>C = Confidence in Sources</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content area - Tables -->
        <div class="content" style="overflow-x: auto; margin-top: 15px;">
            
            {% set residents = neighbors|selectattr('entity_category', 'equalto', 'Resident')|list %}
            {% set organizations = neighbors|selectattr('entity_category', 'equalto', 'Organization')|list %}
            
            {% if residents %}
            <!-- Residents Section -->
            <div class="section-group">
                <h3 style="font-family: 'DM Sans', sans-serif; font-size: 14pt; color: var(--hp-navy); margin-top: 30px; margin-bottom: 7.5px; font-weight: 600;">Residents</h3>
                
                <!-- {% if residents_summary %}
                <div class="section-summary">
                    {{ residents_summary }}
                </div>
                {% endif %} -->
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 3%;">#</th>
                            <th style="width: 9%;">PINs</th>
                            <th style="width: 4%;">Adj.</th>
                            <th style="width: 11%;">Name</th>
                            <th style="width: 8%;">Type</th>
                            <th style="width: 31%;">Claims</th>
                            <th style="width: 10%;">Stance</th>
                            <th style="width: 6%;">Influence</th>
                            <th style="width: 14%;">Approach</th>
                            <th style="width: 4%;">C</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in residents %}
                        <tr>
                            <td style="font-size: 7pt; font-weight: 700; text-align: center; color: #0B1D3A;">{{ r.map_marker if r.map_marker else '' }}</td>
                            <td style="font-size: 6.5pt;">{{ r.pins|join(', ')|normalize_pin if r.pins else '' }}</td>
                            <td style="text-align: center;">{{ '✓' if r.owns_adjacent_parcel == 'Yes' else '' }}</td>
                            <td><strong>{{ r.name if r.name else '' }}</strong></td>
                            <td>{{ r.entity_type if r.entity_type else '' }}</td>
                            <td style="font-size: 6.5pt; line-height: 1.3;">{{ (r.claims|format_citations)|safe if r.claims else '' }}</td>
                            <td style="font-size: 6.5pt;" class="{% if r.noted_stance and 'support' in r.noted_stance|lower %}stance-support{% elif r.noted_stance and 'oppos' in r.noted_stance|lower %}stance-opposed{% else %}stance-unknown{% endif %}">{{ (r.noted_stance|format_citations)|safe if r.noted_stance else '' }}</td>
                            <td style="font-size: 6.5pt;">{% if r.community_influence %}<span class="badge {% if r.community_influence|lower == 'high' %}badge-high{% elif r.community_influence|lower == 'medium' %}badge-medium{% else %}badge-low{% endif %}">{{ r.community_influence }}</span>{% endif %}</td>
                            <td style="font-size: 6.5pt; white-space: pre-wrap;">{{ (r.approach_recommendations|format_citations)|safe if r.approach_recommendations else '' }}</td>
                            <td>{{ r.confidence if r.confidence else '' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
            {% if organizations %}
            <!-- Organizations Section -->
            <div class="section-group" style="page-break-before: always;">
                <div class="organizations-header-group">
                    <h3 style="font-family: 'DM Sans', sans-serif; font-size: 14pt; color: var(--hp-navy); margin-top: 30px; margin-bottom: 7.5px; font-weight: 600;">Entities</h3>
                    
                    <!-- {% if organizations_summary %}
                    <div class="section-summary">
                        {{ organizations_summary }}
                    </div>
                    {% endif %} -->
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 3%;">#</th>
                            <th style="width: 9%;">PINs</th>
                            <th style="width: 4%;">Adj.</th>
                            <th style="width: 10%;">Name</th>
                            <th style="width: 8%;">Type</th>
                            <th style="width: 31%;">Claims</th>
                            <th style="width: 6%;">Influence</th>
                            <th style="width: 11%;">Classification</th>
                            <th style="width: 14%;">Approach</th>
                            <th style="width: 4%;">C</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in organizations %}
                        <tr>
                            <td style="font-size: 7pt; font-weight: 700; text-align: center; color: #0B1D3A;">{{ r.map_marker if r.map_marker else '' }}</td>
                            <td style="font-size: 6.5pt;">{{ r.pins|join(', ')|normalize_pin if r.pins else '' }}</td>
                            <td style="text-align: center;">{{ '✓' if r.owns_adjacent_parcel == 'Yes' else '' }}</td>
                            <td><strong>{{ r.name if r.name else '' }}</strong></td>
                            <td>{{ r.entity_type if r.entity_type else '' }}</td>
                            <td style="font-size: 6.5pt; line-height: 1.3;">{{ (r.claims|format_citations)|safe if r.claims else '' }}</td>
                            <td style="font-size: 6.5pt;">{% if r.community_influence %}<span class="badge {% if r.community_influence|lower == 'high' %}badge-high{% elif r.community_influence|lower == 'medium' %}badge-medium{% else %}badge-low{% endif %}">{{ r.community_influence }}</span>{% endif %}</td>
                            <td style="font-size: 6.5pt;">{{ r.entity_classification if r.entity_classification else '' }}</td>
                            <td style="font-size: 6.5pt; white-space: pre-wrap;">{{ (r.approach_recommendations|format_citations)|safe if r.approach_recommendations else '' }}</td>
                            <td>{{ r.confidence[0]|upper if r.confidence else '' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        
        <!-- Footer area (empty for cleaner look) -->
        <div class="footer"></div>
        
    </section>
</body>
</html>